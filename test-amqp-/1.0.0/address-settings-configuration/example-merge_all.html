<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Example: merge_all :: Address Settings for AMQ Broker on OpenShift</title>
    <link rel="prev" href="specifying-how-the-operator-applies-the-configuration.html">
    <link rel="next" href="../avoiding-default-configuration-inclusion/avoiding-default-configuration-inclusion.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Address Settings for AMQ Broker on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="test-amqp-" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Address Settings for AMQ Broker on OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../configuring-address-settings/configuring-address-settings.html">Configuring Address Settings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/using-brokerproperties-attribute-in-activemqartemis-cr-instance.html">Using brokerProperties attribute in ActiveMQArtemis CR instance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/configuring-address-settings-under-brokerproperties.html">Configuring address settings under brokerProperties</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/example-configuring-dead-letter-address-and-queue-for-specific-address-patterns.html">Example: Configuring dead letter address and queue for specific address patterns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/using-activemqartemisaddress-cr-instance.html">Using ActiveMQArtemisAddress CR instance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/configuring-address-settings-in-addresssettings-section-of-activemqartemis-cr.html">Configuring address settings in addressSettings section of ActiveMQArtemis CR</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuring-address-settings/example-configuring-dead-letter-address-and-queue-for-specific-address-patterns.html">Example: Configuring dead letter address and queue for specific address patterns</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="address-settings-configuration.html">Address Settings Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="match-property.html">match property</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="enclosing-value-in-single-quotation-marks-for-example-myotheraddresses.html">Enclosing value in single quotation marks, for example, myOtherAddresses#</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="applyrule-property.html">applyRule property</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="specifying-how-the-operator-applies-the-configuration.html">Specifying how the Operator applies the configuration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="example-merge_all.html">Example: merge_all</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../avoiding-default-configuration-inclusion/avoiding-default-configuration-inclusion.html">Avoiding Default Configuration Inclusion</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../avoiding-default-configuration-inclusion/not-including-properties-specified-in-the-default-configuration-even-if-not-specified-in-the-cr.html">Not including properties specified in the default configuration, even if not specified in the CR</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../overlapping-address-settings/overlapping-address-settings.html">Overlapping Address Settings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overlapping-address-settings/ensuring-not-to-include-properties-with-the-same-value-in-both-cr-and-default-entry-sub-entry.html">Ensuring not to include properties with the same value in both CR and default Entry Sub-entry</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Address Settings for AMQ Broker on OpenShift</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Address Settings for AMQ Broker on OpenShift</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Address Settings for AMQ Broker on OpenShift</a></li>
    <li><a href="address-settings-configuration.html">Address Settings Configuration</a></li>
    <li><a href="example-merge_all.html">Example: merge_all</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Example: merge_all</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section demonstrates how to use the <code>merge_all</code> value for the <code>applyRule</code> property within AMQ Broker&#8217;s address settings on OpenShift. The <code>merge_all</code> rule provides a flexible approach to combining address configurations defined in your <code>ActiveMQArtemis</code> Custom Resource (CR) instance with the broker&#8217;s default settings.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_understanding_applyrule_merge_all"><a class="anchor" href="#_example_understanding_applyrule_merge_all"></a>Example: Understanding <code>applyRule: merge_all</code></h3>
<div class="paragraph">
<p>The <code>applyRule</code> property dictates how the OpenShift Operator applies the address settings defined in your <code>ActiveMQArtemis</code> CR for a specific address or set of addresses. When <code>applyRule</code> is set to <code>merge_all</code>, the Operator intelligently combines your CR&#8217;s configuration with the broker&#8217;s existing default settings.</p>
</div>
<div class="paragraph">
<p>The behavior of <code>merge_all</code> is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Overlapping Properties</strong>: For any address settings property that is defined in <strong>both</strong> your CR and the default configuration (and matches the same address or address pattern):</p>
</li>
<li>
<p>The property value specified in your CR <strong>replaces</strong> the corresponding value from the default configuration.</p>
</li>
<li>
<p><strong>Unique Properties</strong>: For any address settings property that is specified <strong>uniquely</strong> in either your CR <strong>or</strong> the default configuration (for the matching address or pattern):</p>
</li>
<li>
<p>That unique property value is retained and included in the final, merged configuration.</p>
</li>
<li>
<p><strong>Unique Address Matches</strong>: For address settings defined in either the CR or the default configuration that <strong>uniquely</strong> match a particular address or set of addresses (i.e., there&#8217;s no corresponding match in the other source):</p>
</li>
<li>
<p>These unique address settings are included entirely in the final, merged configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Essentially, <code>merge_all</code> prioritizes CR-defined values for overlapping properties but ensures that no useful settings from either source are lost if they are unique. It aims to create a comprehensive configuration by combining all relevant properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you do not explicitly include the <code>applyRule</code> property in your <code>ActiveMQArtemis</code> CR, the Operator uses <code>merge_all</code> as the default value.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_hands_on_activity_configuring_address_settings_with_merge_all"><a class="anchor" href="#_hands_on_activity_configuring_address_settings_with_merge_all"></a>Hands-on Activity: Configuring Address Settings with <code>merge_all</code></h4>
<div class="paragraph">
<p>In this activity, you will deploy an AMQ Broker instance and configure address settings using the <code>merge_all</code> rule. We&#8217;ll simulate a scenario where default broker settings exist, and we want to augment or override specific properties with our CR definition.</p>
</div>
<div class="paragraph">
<p>Assume a hypothetical default configuration for an address pattern <code>myAddress#</code> that includes <code>maxDeliveryAttempts</code> and <code>redeliveryDelay</code>, and a default <code>deadLetterAddress</code>.</p>
</div>
<div class="sect4">
<h5 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h5>
<div class="ulist">
<ul>
<li>
<p>An OpenShift cluster with <code>oc</code> CLI configured.</p>
</li>
<li>
<p>The AMQ Broker Operator installed on the cluster.</p>
</li>
<li>
<p>Basic understanding of OpenShift Custom Resources.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_steps"><a class="anchor" href="#_steps"></a>Steps</h5>
<div class="paragraph">
<div class="title">1. <strong>Examine the Hypothetical Default Broker Configuration</strong></div>
<p>Imagine the AMQ Broker&#8217;s default configuration includes the following settings for addresses matching <code>myAddress#</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
   &lt;address-settings&gt;
      &lt;address-setting match="myAddress#"&gt;
         &lt;max-delivery-attempts&gt;5&lt;/max-delivery-attempts&gt;
         &lt;redelivery-delay&gt;1000&lt;/redelivery-delay&gt;
         &lt;dead-letter-address&gt;DLQ.DEFAULT&lt;/dead-letter-address&gt;
         &lt;last-value-queue&gt;false&lt;/last-value-queue&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;/address-setting&gt;
      &lt;address-setting match="anotherAddress#"&gt;
         &lt;max-size-bytes&gt;10485760&lt;/max-size-bytes&gt;
         &lt;message-counter-history-day-limit&gt;7&lt;/message-counter-history-day-limit&gt;
      &lt;/address-setting&gt;
   &lt;/address-settings&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This property <code>last-value-queue</code> is unique to the default for <code>myAddress#</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">2. <strong>Create an <code>ActiveMQArtemis</code> CR with <code>merge_all</code> Address Settings</strong></div>
<p>You will create an <code>ActiveMQArtemis</code> CR named <code>my-broker-with-merged-settings</code>. This CR will define address settings for <code>myAddress#</code> and <code>newAddress#</code>.</p>
</div>
<div class="paragraph">
<p>For <code>myAddress#</code>:
*   We&#8217;ll <strong>override</strong> <code>maxDeliveryAttempts</code> and <code>redeliveryDelay</code>.
*   We&#8217;ll <strong>add</strong> a unique property <code>maxSizeBytes</code>.</p>
</div>
<div class="paragraph">
<p>For <code>newAddress#</code>:
*   We&#8217;ll define entirely new settings as this pattern is not in our hypothetical default.</p>
</div>
<div class="paragraph">
<p>Create a file named <code>broker-merged-config.yaml</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker-with-merged-settings
spec:
  deploymentPlan:
    size: 1
    image: registry.redhat.io/amq7/amq-broker-rhel8:latest
  addressSettings:
    - match: myAddress#
      applyRule: merge_all
      maxDeliveryAttempts: 10 # Overwrites default (5 -&gt; 10)
      redeliveryDelay: 500    # Overwrites default (1000 -&gt; 500)
      maxSizeBytes: 20971520  # Unique to CR for this match
    - match: newAddress#
      applyRule: merge_all    # Can be omitted, as merge_all is default
      redeliveryDelay: 2000
      expiryDelay: -1</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">3. <strong>Deploy the Broker Instance</strong></div>
<p>Apply the CR to your OpenShift cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f broker-merged-config.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the broker pod is running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -l app=my-broker-with-merged-settings</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">4. <strong>Verify the Merged Configuration</strong></div>
<p>Once the broker is running, you can connect to the broker pod to inspect its live configuration. The AMQ Broker&#8217;s configuration typically resides in <code>/home/jboss/amq-broker/broker.xml</code>.</p>
</div>
<div class="paragraph">
<p>Connect to the broker pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rsh &lt;broker-pod-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to the configuration directory and view the <code>broker.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd /home/jboss/amq-broker/etc/
cat broker.xml | grep -A 10 -B 1 "&lt;address-setting match=\"myAddress#\"&gt;"
cat broker.xml | grep -A 10 -B 1 "&lt;address-setting match=\"newAddress#\"&gt;"
cat broker.xml | grep -A 10 -B 1 "&lt;address-setting match=\"anotherAddress#\"&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should observe the following in the <code>broker.xml</code> file (or similar structure):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>For <code>myAddress#</code></strong>:</p>
</li>
<li>
<p><code>max-delivery-attempts</code> will be <code>10</code> (from CR).</p>
</li>
<li>
<p><code>redelivery-delay</code> will be <code>500</code> (from CR).</p>
</li>
<li>
<p><code>dead-letter-address</code> will be <code>DLQ.DEFAULT</code> (from default, as it was not overridden by the CR).</p>
</li>
<li>
<p><code>last-value-queue</code> will be <code>false</code> (from default, as it was not overridden by the CR).</p>
</li>
<li>
<p><code>max-size-bytes</code> will be <code>20971520</code> (from CR, as it was unique to the CR for this match).
This demonstrates how <code>merge_all</code> combines properties, prioritizing CR values for overlaps and including unique properties from both sources.</p>
</li>
<li>
<p><strong>For <code>newAddress#</code></strong>:</p>
</li>
<li>
<p>You will see the settings <code>redelivery-delay</code> and <code>expiry-delay</code> as defined in your CR, as this pattern was unique to the CR.</p>
</li>
<li>
<p><strong>For <code>anotherAddress#</code></strong>:</p>
</li>
<li>
<p>You will still see <code>max-size-bytes</code> and <code>message-counter-history-day-limit</code> from the hypothetical default, as this pattern was unique to the default and not addressed by the CR.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This confirms that the <code>merge_all</code> rule successfully combined the CR-defined settings with the broker&#8217;s underlying default configuration, applying overrides where specified in the CR and retaining unique properties from both.</p>
</div>
</div>
<div class="sect4">
<h5 id="_cleanup"><a class="anchor" href="#_cleanup"></a>Cleanup</h5>
<div class="paragraph">
<p>Delete the broker instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -f broker-merged-config.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="specifying-how-the-operator-applies-the-configuration.html">Specifying how the Operator applies the configuration</a></span>
  <span class="next"><a href="../avoiding-default-configuration-inclusion/avoiding-default-configuration-inclusion.html">Avoiding Default Configuration Inclusion</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>

#  Monitoring and troubleshooting client connections

== Monitoring and troubleshooting client connections

Monitoring and troubleshooting client connections is a crucial aspect of ensuring the smooth operation of your Red Hat AMQ deployment on OpenShift. This section will guide you through the process of identifying and resolving common issues that may arise when external clients connect to your AMQ brokers.

### 1. Monitoring Client Connections

To effectively monitor client connections, you can utilize various tools and techniques:

- **AMQ Console**: The AMQ Console provides a web-based user interface for managing and monitoring AMQ brokers. You can view the list of connected clients, their connection details, and message flow statistics. To access the AMQ Console, navigate to the AMQ broker's route in your OpenShift cluster.

- **Prometheus and Grafana**: Prometheus is a powerful monitoring and alerting toolkit, while Grafana is a visualization tool. By integrating Prometheus with AMQ, you can collect metrics and visualize them using Grafana dashboards. This setup allows you to monitor key performance indicators (KPIs) such as message rates, connection counts, and memory usage.

- **JMX Monitoring**: AMQ brokers expose JMX metrics that can be monitored using tools like JConsole or custom scripts. This method is useful for gathering detailed, low-level metrics about broker performance and resource usage.

### 2. Troubleshooting Client Connections

When issues arise with client connections, follow these steps to identify and resolve the problem:

- **Verify Client Configuration**: Ensure that the client is correctly configured with the appropriate connection details (host, port, username, password, etc.). Double-check the connection URL and any security settings.

- **Check Broker Logs**: Examine the AMQ broker logs for any error messages or warnings related to the client connection. The logs can be found in the broker's data directory or accessed through the AMQ Console.

- **Inspect Network Connectivity**: Confirm that there are no network issues preventing the client from connecting to the broker. Use tools like `ping`, `traceroute`, or `telnet` to test connectivity between the client and broker.

- **Review Broker Metrics**: Analyze the broker's metrics using Prometheus, Grafana, or JMX to identify any resource bottlenecks or performance issues that may be affecting client connections.

- **Test with a Different Client**: If possible, test the connection using a#  Monitoring and troubleshooting client connections

== Monitoring and Troubleshooting AMQ Client Connections

This section provides a detailed exploration of monitoring the health, performance, and connectivity of external clients interacting with your Red Hat AMQ brokers deployed on OpenShift. It also covers practical strategies and hands-on activities for effectively troubleshooting common connection-related issues.

Monitoring client connections is critical for ensuring the reliability, performance, and security of your message-oriented middleware infrastructure. By proactively monitoring, you can identify potential bottlenecks, security breaches, or system failures before they impact your applications.

=== Understanding the Need for Monitoring

Monitoring client connections to Red Hat AMQ brokers on OpenShift offers several vital benefits:

*   *Performance Assurance*: Track connection latency, message throughput, and resource utilization to ensure optimal performance and responsiveness of your messaging system.
*   *Availability and Reliability*: Detect connection drops, disconnections, or failed connection attempts promptly, allowing for quick intervention to maintain high availability.
*   *Security Compliance*: Monitor authentication and authorization attempts to identify unauthorized access attempts or suspicious activity, helping enforce security policies.
*   *Resource Management*: Understand how many connections are active, which queues/topics they are interacting with, and the resources they consume, aiding in capacity planning and scaling decisions.
*   *Troubleshooting Efficiency*: Provide crucial diagnostic information when problems arise, enabling faster identification and resolution of issues.

=== Key Monitoring Tools and Techniques

Red Hat AMQ on OpenShift offers a variety of tools and methods to monitor client connections and broker health.

==== AMQ Console (Hawtio)

The AMQ Console, powered by Hawtio, is a web-based management console embedded within the AMQ Broker pod. It provides a rich interface for monitoring and managing various aspects of your broker, including active client connections, queues, topics, subscriptions, and security settings.

*   *Features*:
    *   View a list of active connections, including client IDs, hostnames, and connection status.
    *   Inspect details of each connection, such as protocols used, message counts, and session information.
    *   Monitor queues and topics for message counts, consumer counts, and enqueue/dequeue rates.
    *   Manage broker configurations, users, and security roles.

==== OpenShift Logging

OpenShift's integrated logging capabilities (e.g., Fluentd, Elasticsearch, Kibana or `oc logs`) are indispensable for troubleshooting. AMQ brokers generate detailed logs for connection attempts, authentication successes/failures, authorization events, message flow, and internal errors.

*   *Usage*:
    *   Stream real-time logs from AMQ broker pods using `oc logs`.
    *   Search historical logs for specific error messages, client IDs, or timestamps using Kibana (if deployed).
    *   Identify patterns of failed connection attempts or repeated errors.

==== OpenShift Monitoring (Prometheus & Grafana)

If your OpenShift cluster has the Prometheus and Grafana monitoring stack deployed, Red Hat AMQ brokers expose JMX metrics that can be scraped by Prometheus. These metrics can then be visualized in Grafana dashboards, providing powerful insights into broker and connection performance over time.

*   *Usage*:
    *   Track connection count trends.
    *   Monitor message rates per connection.
    *   Observe resource utilization (CPU, memory) correlated with connection load.

==== `oc` CLI Tools

The OpenShift Command Line Interface (`oc`) provides fundamental tools for inspecting the state of your AMQ deployment and underlying infrastructure.

*   *`oc get pods`, `oc describe pod`*: Check the status, events, and resource usage of AMQ broker pods.
*   *`oc logs <pod-name>`*: Access real-time or historical logs from a specific broker pod.
*   *`oc exec <pod-name> -- <command>`*: Execute commands inside a running broker pod for advanced diagnostics (e.g., `netstat` to check network connections).
*   *`oc get route`*: Verify the external routes exposing your AMQ broker for client access.

=== Common Troubleshooting Scenarios

Understanding common failure points is key to efficient troubleshooting.

==== Connection Refused/Timeout

*   *Symptoms*: Client application logs show `Connection refused`, `Connection timeout`, or `No route to host`.
*   *Causes*:
    *   AMQ broker pod is not running or is unhealthy.
    *   Incorrect hostname, IP address, or port in the client configuration.
    *   Network connectivity issues between the client and OpenShift (e.g., firewall blocking the port, incorrect network policies).
    *   OpenShift Route is misconfigured or not accessible externally.
*   *Troubleshooting Steps*:
    1.  Verify AMQ broker pod status: `oc get pods -n <amq-project>`
    2.  Check OpenShift Route: `oc get route -n <amq-project>` and confirm the hostname and port.
    3.  From the client machine, attempt `telnet <amq-route-hostname> <amqp-port>` to verify basic network reachability.
    4.  Inspect AMQ broker logs for any startup errors.

==== Authentication Failures

*   *Symptoms*: Client application logs show `Authentication failed`, `Invalid credentials`, or similar errors. AMQ broker logs show messages like `Authentication failed for user '...'`.
*   *Causes*:
    *   Incorrect username or password provided by the client.
    *   The specified user does not exist in the AMQ broker's security configuration (e.g., `broker.xml` or connected external identity provider).
    *   Issues with the external Identity Provider (IdP) if configured (e.g., LDAP, Keycloak).
*   *Troubleshooting Steps*:
    1.  Verify client application's configured username and password.
    2.  Check AMQ broker configuration for existing users and their credentials.
    3.  If using an external IdP, verify its connectivity and the user's existence/credentials within the IdP.
    4.  Examine AMQ broker logs for detailed authentication failure reasons.

==== Authorization Failures

*   *Symptoms*: Client connects successfully but receives `Authorization failed`, `Permission denied`, or `Access denied` when trying to send/receive messages from a specific queue or topic. AMQ broker logs show `User '...' not authorized to perform action '...' on queue/topic '...'`.
*   *Causes*:
    *   The authenticated user lacks the necessary permissions (read, write, create) for the target queue or topic.
    *   Incorrect security roles assigned to the user in AMQ's authorization configuration.
*   *Troubleshooting Steps*:
    1.  Verify the user's assigned roles in AMQ's `broker.xml` or via the Hawtio console.
    2.  Check the `authorization` configuration in `broker.xml` to ensure the roles have appropriate permissions for the queues/topics the client is trying to access.

==== Message Send/Receive Issues

*   *Symptoms*: Client connects but messages are not being sent, received, or are significantly delayed.
*   *Causes*:
    *   Queue or topic is full (due to slow consumers or high message production).
    *   Message expiry settings are too aggressive.
    *   Network latency or high load affecting message transmission.
    *   Client application logic errors (e.g., incorrect destination name, wrong message format).
    *   Broker resource constraints (e.g., low disk space, high memory usage).
*   *Troubleshooting Steps*:
    1.  Use the AMQ Console to check message counts, consumer counts, and enqueue/dequeue rates for the affected queues/topics.
    2.  Check broker logs for any warnings related to resource limits or message expiry.
    3.  Examine client application logs for any errors during message production or consumption.
    4.  Monitor broker pod resources using `oc top pod -n <amq-project>`.

==== TLS/SSL Handshake Issues

*   *Symptoms*: Client application logs show `SSLHandshakeException`, `CertificateExpiredException`, `UntrustedCertificateException`, or similar errors during connection setup.
*   *Causes*:
    *   Client does not trust the broker's certificate (missing CA certificate in client's trust store).
    *   Broker's certificate is expired or invalid.
    *   Client or broker is configured with an incorrect TLS protocol version or cipher suite.
    *   Hostname mismatch between the certificate's Common Name (CN) or Subject Alternative Name (SAN) and the connection hostname.
*   *Troubleshooting Steps*:
    1.  Verify the validity and expiry of the AMQ broker's TLS certificate.
    2.  Ensure the client application's trust store contains the appropriate CA certificate that signed the broker's certificate.
    3.  Check client and broker TLS configuration for compatible protocol versions and cipher suites.
    4.  Confirm the client is connecting to the correct hostname that matches the broker's certificate.

=== Hands-on Lab: Monitoring and Troubleshooting Client Connections

This lab activity will guide you through common monitoring tasks using the AMQ Console and OpenShift logs, and then simulate and troubleshoot a client connection issue.

==== Prerequisites

*   An active OpenShift cluster with Red Hat AMQ deployed in a project named `amq-broker-project`.
*   You have successfully deployed a simple AMQ client application (e.g., a message producer/consumer) in your OpenShift cluster or on your local machine, configured to connect to your AMQ broker. Refer to the "Accessing AMQ deployed on OpenShift through external clients" lab if needed.
*   You have `oc` CLI access to your OpenShift cluster.

==== Activity 1: Monitoring Connections via AMQ Console

This activity demonstrates how to view active client connections using the AMQ Console.

.  Log in to your OpenShift cluster as a user with appropriate permissions for the `amq-broker-project`.
.  Identify the route for your AMQ broker's Hawtio console:
    [source,bash]
    ----
    oc get route amq-broker-amq-console -n amq-broker-project -o jsonpath='{.spec.host}'
    ----
    This command will output the hostname for your AMQ Console.
.  Open a web browser and navigate to the Hawtio console URL (e.g., `https://<amq-broker-amq-console-route-hostname>`). You may need to accept a self-signed certificate if not using a trusted CA.
.  Log in to the Hawtio console using the credentials configured for your AMQ broker (e.g., `admin`/`admin` if using default `broker.xml` users).
.  In the left-hand navigation pane, expand *ActiveMQ Artemis* -> *<YourBrokerName>* -> *Connections*.
.  Initially, you might see few or no client connections if your client application is not running.
.  *Start your client application*. If it's an OpenShift deployment, ensure its pod is running. If it's a local client, execute its run command.
.  *Observe*: Refresh the *Connections* view in the Hawtio console. You should now see an entry for your client connection, typically identified by its client ID and originating IP address.
.  Click on the client connection entry to view more details, such as the protocol used, last activity, and session information.
.  *Stop your client application*. Observe the connection disappearing from the Hawtio console after a short delay or refreshing the page.

==== Activity 2: Inspecting Broker Logs for Connection Events

Broker logs provide granular details about connection attempts and their outcomes.

.  Identify the AMQ broker pod name:
    [source,bash]
    ----
    oc get pods -n amq-broker-project -l app.kubernetes.io/name=amq-broker
    ----
    Note the name of the running broker pod (e.g., `amq-broker-ss-0`).
.  Stream the logs of the AMQ broker pod:
    [source,bash]
    ----
    oc logs <amq-broker-pod-name> -n amq-broker-project -f
    ----
    Keep this terminal window open to observe real-time logs.
.  *Start your client application*.
.  *Observe*: In the streaming logs, you should see entries indicating a successful connection. Look for messages similar to:
    `INFO [org.apache.activemq.artemis.core.server] AMQ221007: Connection ... accepted from /<client-ip>:<client-port>`
    `INFO [org.apache.activemq.artemis.core.server] AMQ221027: ActiveMQClientProtocolManager.onSessionCreate ...`
.  *Stop your client application*.
.  *Observe*: You should see log entries indicating the client disconnecting:
    `INFO [org.apache.activemq.artemis.core.server] AMQ221008: Apache ActiveMQ Artemis Server will now close the connection`

==== Activity 3: Troubleshooting a Simulated Authentication Failure

This activity simulates an authentication failure and demonstrates how to diagnose it using broker and client logs.

.  *Simulate Incorrect Credentials in Client*:
    *   Locate your client application's configuration where it specifies the AMQ username and password.
    *   Intentionally change the password to an incorrect value (e.g., append "wrong" to it).
    *   Save the client configuration changes.
.  *Attempt Connection with Incorrect Credentials*:
    *   Start your client application with the modified, incorrect credentials.
    *   *Observe client logs*: Your client application logs should immediately show an authentication failure message (e.g., `AuthenticationFailureException`, `Invalid credentials`).
.  *Check Broker Logs for Authentication Failure*:
    *   In the terminal where you are streaming AMQ broker logs (`oc logs -f ...`), observe the output.
    *   You should see entries similar to:
        `WARN [org.apache.activemq.artemis.core.server] AMQ222002: Authentication failed for user 'amq-user'.`
        `WARN [org.apache.activemq.artemis.core.server] AMQ222061: Invalid user name or password for user amq-user`
    *   This clearly indicates that the broker rejected the connection due to invalid authentication.
.  *Remedy and Verify*:
    *   Stop your client application.
    *   Correct the password in your client application's configuration back to the valid one.
    *   Start your client application again.
    *   *Verify*: Check both client and broker logs. You should now see successful connection messages in both, and no authentication failure warnings in the broker logs.

==== Activity 4: Diagnosing Network Issues (Conceptual Walkthrough)

While difficult to create a fully hands-on simulated network issue without modifying cluster networking, understanding the steps is crucial.

.  *Verify AMQ Broker Route Accessibility*:
    *   Ensure your client can resolve the AMQ route's hostname. On your client machine:
        [source,bash]
        ----
        ping <amq-broker-amqp-route-hostname>
        ----
        (Replace `<amq-broker-amqp-route-hostname>` with the hostname of your AMQ's AMQP route, e.g., `amq-broker-amqp-amq-broker-project.apps.cluster.example.com`).
    *   Test basic port connectivity. From your client machine, if `telnet` is available:
        [source,bash]
        ----
        telnet <amq-broker-amqp-route-hostname> <amqp-port>
        ----
        A successful connection will show a blank screen or a prompt. A failure will report "Connection refused" or "No route to host." This tests if a path exists and if the AMQ broker is listening on the expected port.
.  *Check OpenShift Network Policies*:
    *   If you encounter connection refused errors even when the broker pod is healthy, network policies might be blocking traffic.
    *   Inspect network policies in your `amq-broker-project` namespace:
        [source,bash]
        ----
        oc get networkpolicy -n amq-broker-project
        ----
    *   Ensure there are policies allowing ingress traffic to the AMQ broker pods from the necessary sources (e.g., from the OpenShift router or specific client IP ranges).
.  *Review Broker Pod Status and Events*:
    *   Check for any issues with the broker pod itself:
        [source,bash]
        ----
        oc describe pod <amq-broker-pod-name> -n amq-broker-project
        ----
    *   Look for `Events` at the bottom for insights into pod startup failures, readiness probe failures, or resource constraints.

By regularly monitoring your AMQ broker and client connections, and by being proficient in troubleshooting common issues using the tools provided by AMQ and OpenShift, you can maintain a robust and reliable messaging infrastructure.
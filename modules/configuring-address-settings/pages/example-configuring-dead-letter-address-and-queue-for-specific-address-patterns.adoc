#  Example: Configuring dead letter address and queue for specific address patterns

Here's the content for configuring dead letter addresses and queues for specific address patterns, presented in Antora AsciiDoc format.

[#config-dlq-address-patterns]
= Example: Configuring Dead Letter Address and Queue for Specific Address Patterns

In message-driven architectures, ensuring reliable message delivery is crucial. Sometimes, messages fail to be delivered to their intended consumers due often to issues like malformed messages, consumer unavailability, or application errors. To prevent these undelivered messages from blocking queues or being lost, Apache ActiveMQ Artemis brokers utilize *Dead Letter Queues* (DLQs).

A Dead Letter Queue acts as a holding area for messages that could not be delivered successfully after a specified number of attempts. A system administrator can later inspect these messages, understand why delivery failed, and decide whether to reprocess them, discard them, or archive them. This mechanism prevents infinite delivery attempts, reduces resource consumption, and provides valuable insights into message processing failures.

This section details how to configure a dead letter address and queue for specific address patterns using the `brokerProperties` attribute in your `ActiveMQArtemis` Custom Resource (CR) instance. While it's also possible to configure address settings within the `addressSettings` section of the `ActiveMQArtemis` CR when using `ActiveMQArtemisAddress` CRs for address configuration, this example focuses on the `brokerProperties` method due to its direct illustration in the provided context.

== Configuring Dead Letter Address and Queue using `brokerProperties`

To configure a dead letter address and queue for specific address patterns, you typically perform two main steps within the `brokerProperties` of your `ActiveMQArtemis` CR:

1.  **Define the Dead Letter Address and Queue:** Create a specific address and an associated queue that will serve as the dead letter destination.
2.  **Configure Address Settings for Target Patterns:** For the addresses that you want to protect, specify the `deadLetterAddress` and `maxDeliveryAttempts` properties. These settings dictate *when* and *where* a message should be moved if it fails delivery multiple times.

=== Key Properties for Dead Letter Configuration

*   `deadLetterAddress`: This property specifies the address to which the broker sends undelivered messages. This should point to the dead letter address you define.
*   `maxDeliveryAttempts`: This integer value defines the maximum number of delivery attempts a broker makes before moving a message to the configured `deadLetterAddress`.
*   `match` property (implicit in `brokerProperties` syntax): When configuring `addressSettings` using `brokerProperties`, the "match" pattern for the address is implicitly defined by the `addressSettings.<address-name-pattern>` syntax. If you use a wildcard expression as part of `<address-name-pattern>`, you *must* enclose the value in single quotation marks, for example, `'myAddressPattern#'`.

=== Wildcard Usage in Address Patterns

You can use wildcard characters in your address patterns to apply settings to groups of addresses:

*   `*` (Asterisk): Matches any sequence of zero or more words at a single delimiter boundary (e.g., `news.*` matches `news.europe` but not `news.europe.sports`).
*   `#` (Number Sign): Matches any sequence of zero or more words across multiple delimiter boundaries (e.g., `news.#` matches `news.europe` and `news.europe.sports`).

Matching of patterns is done at each delimiter boundary, which is represented by a period (`.`).

=== Example Configuration

Let's consider an example where we want to configure a dead letter queue for messages initially destined for addresses matching the pattern `usa-news` and `other-regions.#`. Messages that fail delivery after 5 attempts to these patterns will be moved to a `usDeadLetter` address and queue.

[source,yaml]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker-deployment
spec:
  # ... other broker configuration ...
  brokerProperties:
    # 1. Define the Dead Letter Address and Queue
    - addressConfigurations.usDeadLetter.routingTypes=MULTICAST
    - addressConfigurations.usDeadLetter.queueConfigs.usDeadLetter-queue.address=usDeadLetter

    # 2. Configure Address Settings for 'usa-news'
    #    Messages for 'usa-news' failing delivery 5 times go to 'usDeadLetter'
    - addressSettings.usa-news.deadLetterAddress=usDeadLetter
    - addressSettings.usa-news.maxDeliveryAttempts=5

    # 3. Configure Address Settings for 'other-regions.#' using a wildcard
    #    Messages for any address starting with 'other-regions.' failing delivery
    #    5 times go to 'usDeadLetter'. Note the single quotes for the wildcard pattern.
    - addressSettings.'other-regions.#'.deadLetterAddress=usDeadLetter
    - addressSettings.'other-regions.#'.maxDeliveryAttempts=5
----

In this example:

*   The `usDeadLetter` address and its `usDeadLetter-queue` are created to serve as the dead letter destination.
*   For any message sent to the `usa-news` address, if the broker attempts delivery 5 times unsuccessfully, the message is moved to the `usDeadLetter` address.
*   Similarly, for any message sent to an address matching `other-regions.#` (e.g., `other-regions.europe`, `other-regions.asia.alerts`), if delivery fails 5 times, the message is moved to `usDeadLetter`.

[#lab-config-dlq-patterns]
== Hands-on Activity: Configure a Dead Letter Address and Queue for Specific Address Patterns

In this lab, you will modify an existing `ActiveMQArtemis` broker deployment on OpenShift to implement a dead letter queue for specific address patterns.

=== Objective

Configure an AMQ Broker instance to move messages to a dedicated dead letter queue if they fail to be delivered to addresses matching `app.failures` or `system.errors.#` after 3 attempts.

=== Prerequisites

*   Access to an OpenShift cluster.
*   The `oc` command-line tool installed and configured.
*   An existing `ActiveMQArtemis` broker instance deployed in a project you can modify. For example, a broker named `my-broker` in the `amq-broker-project` namespace.

=== Steps

.   **Log in to OpenShift**
    Open your terminal and log in to your OpenShift cluster:
    [source,bash]
    ----
    oc login -u <your_username> -p <your_password> --server=<your_openshift_api_url>
    ----

.   **Switch to the Project**
    Switch to the OpenShift project where your AMQ Broker is deployed:
    [source,bash]
    ----
    oc project amq-broker-project
    ----
    (Replace `amq-broker-project` with your actual project name).

.   **Edit the `ActiveMQArtemis` Custom Resource**
    You will edit the `ActiveMQArtemis` CR for your broker instance. This will open the YAML definition in your default editor.
    [source,bash]
    ----
    oc edit ActiveMQArtemis my-broker
    ----
    (Replace `my-broker` with the name of your broker instance).

.   **Add Dead Letter Configuration under `brokerProperties`**
    Navigate to the `spec.brokerProperties` section. If this section does not exist, you will need to add it.
    Add the following lines to define the dead letter address and queue, and then configure the address settings for the target patterns.

    [source,yaml]
    ----
    # ... (existing ActiveMQArtemis CR content) ...
    spec:
      # ... (other existing spec properties) ...
      brokerProperties:
        # Define the Dead Letter Address and Queue
        - addressConfigurations.dlq.routingTypes=MULTICAST
        - addressConfigurations.dlq.queueConfigs.dlq-queue.address=dlq

        # Configure Address Settings for 'app.failures'
        - addressSettings.app.failures.deadLetterAddress=dlq
        - addressSettings.app.failures.maxDeliveryAttempts=3

        # Configure Address Settings for 'system.errors.#' using a wildcard
        # Note the single quotes around 'system.errors.#' as it contains a wildcard.
        - addressSettings.'system.errors.#'.deadLetterAddress=dlq
        - addressSettings.'system.errors.#'.maxDeliveryAttempts=3
    ----

    *Self-Correction Note:* Ensure you maintain correct YAML indentation and structure when adding these properties. Each `-` indicates a new item in the `brokerProperties` list.

.   **Save and Apply Changes**
    Save the changes and exit your editor. OpenShift will automatically apply the updated `ActiveMQArtemis` CR, and the Operator will reconcile the broker deployment. This might trigger a restart of the broker pods to apply the new configuration.

.   **Verify the Configuration (Optional)**
    While direct verification of DLQ functionality without an actual message failure scenario is complex, you can ensure the broker pods are running and healthy after the update.
    [source,bash]
    ----
    oc get pods -l app=my-broker # Replace 'my-broker' with your broker's app label
    ----
    You can also inspect the broker's configuration file (e.g., `broker.xml` within the broker pod) by exec'ing into the pod, though this is advanced and not always necessary as the Operator manages this.

    To functionally test, you would typically:
    *   Send a message to an address like `app.failures` or `system.errors.critical`.
    *   Ensure there are no consumers for these queues, or configure a consumer that deliberately fails to acknowledge messages.
    *   After 3 delivery attempts, the message should appear in the `dlq-queue`. You could use an AMQ console or another client to inspect the `dlq-queue` contents.

This hands-on activity demonstrates how to robustly handle message delivery failures by directing undeliverable messages to a dedicated dead letter queue, improving the reliability and observability of your messaging system.#  Example: Configuring dead letter address and queue for specific address patterns

This section demonstrates how to configure a dead letter address and queue, and then apply these settings to specific address patterns within your AMQ Broker deployment on OpenShift. A dead letter address and queue are crucial for handling messages that cannot be delivered to their intended clients, preventing infinite delivery attempts and allowing administrators to inspect undelivered messages.

== Configuring Dead Letter Address and Queue for Specific Address Patterns

You can configure address settings, including dead letter addresses and queues, using the `brokerProperties` attribute within your `ActiveMQArtemis` Custom Resource (CR) instance. This method allows you to define flexible rules for message delivery and undeliverable message handling.

=== Understanding Dead Lettering

When a message cannot be successfully delivered to a client after a specified number of attempts, the broker can redirect it to a designated *dead letter address*. This address typically has an associated *dead letter queue* where these undelivered messages are stored. This mechanism is vital for:

*   **Preventing resource exhaustion:** Avoiding continuous retries on undeliverable messages.
*   **Debugging and analysis:** Allowing administrators to inspect messages that failed delivery to understand the cause.
*   **Data integrity:** Ensuring no messages are lost due to transient client issues.

=== Configuration Steps using `brokerProperties`

To configure a dead letter address and queue for specific address patterns, you will modify your `ActiveMQArtemis` CR instance.

==== Step 1: Define the Dead Letter Address and Queue

First, you need to define the address and queue that will serve as your dead letter destination. Add the following entries under the `brokerProperties` attribute in your `ActiveMQArtemis` CR.

.Example: Defining a dead letter address and queue
[source,yaml]
----
apiVersion: activemq.broker.amq.io/v1beta2
kind: ActiveMQArtemis
metadata:
  name: ex-all-artemis
spec:
  # ... other broker configurations
  brokerProperties:
    # ... existing broker properties
    - addressConfigurations.usDeadLetter.routingTypes=MULTICAST
    - addressConfigurations.usDeadLetter.queueConfigs.usDeadLetter-queue.address=usDeadLetter
    # ... other address settings
----

*   `addressConfigurations.usDeadLetter.routingTypes=MULTICAST`: This line creates a new address named `usDeadLetter` with `MULTICAST` routing. You could also use `ANYCAST` depending on your requirements.
*   `addressConfigurations.usDeadLetter.queueConfigs.usDeadLetter-queue.address=usDeadLetter`: This line creates a queue named `usDeadLetter-queue` that is bound to the `usDeadLetter` address. This queue will receive messages routed to `usDeadLetter`.

==== Step 2: Apply Dead Letter Settings to a Specific Address

Now, link a specific address to the `usDeadLetter` address you just created. For example, if you have an address named `usa-news`, you can configure messages failing delivery to this address to be sent to `usDeadLetter`.

.Example: Applying dead letter settings to a specific address
[source,yaml]
----
apiVersion: activemq.broker.amq.io/v1beta2
kind: ActiveMQArtemis
metadata:
  name: ex-all-artemis
spec:
  # ... other broker configurations
  brokerProperties:
    # ... existing broker properties, including usDeadLetter definition
    - addressSettings.usa-news.deadLetterAddress=usDeadLetter
    - addressSettings.usa-news.maxDeliveryAttempts=5
    # ... other address settings
----

*   `addressSettings.usa-news.deadLetterAddress=usDeadLetter`: This configures the `usa-news` address to send any undeliverable messages to the `usDeadLetter` address.
*   `addressSettings.usa-news.maxDeliveryAttempts=5`: This specifies that the broker will attempt to deliver a message to a client subscribing to `usa-news` up to 5 times. If all attempts fail, the message will be moved to `usDeadLetter`.

==== Step 3: Apply Dead Letter Settings to an Address Pattern

You can extend this configuration to apply dead letter settings to a group of addresses that match a specific pattern using wildcards. The most common wildcards are:

*   `*` (asterisk): Matches any sequence of zero or more characters within a single word (delimited by `.`).
*   `#` (number sign): Matches any sequence of zero or more words.

When using wildcards in the `match` property, you *must* enclose the value in single quotation marks.

.Example: Applying dead letter settings to an address pattern
[source,yaml]
----
apiVersion: activemq.broker.amq.io/v1beta2
kind: ActiveMQArtemis
metadata:
  name: ex-all-artemis
spec:
  # ... other broker configurations
  brokerProperties:
    # ... existing broker properties, including usDeadLetter definition
    - addressSettings.usa-news.deadLetterAddress=usDeadLetter
    - addressSettings.usa-news.maxDeliveryAttempts=5
    - addressSettings.'myOtherAddresses#'.match='myOtherAddresses#' # <1>
    - addressSettings.'myOtherAddresses#'.deadLetterAddress=usDeadLetter
    - addressSettings.'myOtherAddresses#'.maxDeliveryAttempts=5
    # ... other address settings
----
<1> The `match` property uses a wildcard. Note the single quotes around `'myOtherAddresses#'`.

*   `addressSettings.'myOtherAddresses#'.match='myOtherAddresses#'`: This line defines an address setting entry that applies to any address starting with `myOtherAddresses`, followed by any sequence of words (e.g., `myOtherAddresses.topic1`, `myOtherAddresses.region.subtopic`).
*   `addressSettings.'myOtherAddresses#'.deadLetterAddress=usDeadLetter`: Messages failing delivery for any address matching `myOtherAddresses#` will be sent to `usDeadLetter`.
*   `addressSettings.'myOtherAddresses#'.maxDeliveryAttempts=5`: Sets the maximum delivery attempts to 5 for addresses matching the pattern.

image:addressSettings.drawio.png[]

_Figure 1: Flow of messages to a dead letter queue based on address patterns_

==== Key Properties for Dead Lettering

*   `deadLetterAddress`: Specifies the address to which undelivered messages will be sent.
*   `maxDeliveryAttempts`: Defines the maximum number of delivery attempts before a message is moved to the `deadLetterAddress`.
*   `match`: (Optional) When used, this property defines the address pattern to which the settings apply. If omitted, the settings apply to the exact address name used in the `addressSettings.<address-name>` part.
*   `applyRule`: (Optional) Specifies how the Operator applies the configuration when there are overlapping address settings. For example, `merge_all`. While not shown in this specific example, it's an important property for complex configurations.

=== Hands-on Activity: Deploying and Testing Dead Letter Configuration

In this activity, you will deploy an AMQ Broker instance with the dead letter configuration and simulate message delivery failures to observe the dead lettering in action.

==== Prerequisites

*   An OpenShift cluster with `oc` CLI configured.
*   The AMQ Broker Operator installed on your OpenShift cluster.

==== Procedure

. **Create the `ActiveMQArtemis` CR:**
   Save the following YAML content to a file named `broker-with-deadletter.yaml`.

   [source,yaml]
   ----
   apiVersion: activemq.broker.amq.io/v1beta2
   kind: ActiveMQArtemis
   metadata:
     name: ex-deadletter-broker
   spec:
     deploymentPlan:
       size: 1
       image: registry.redhat.io/amq7/amq-broker-rhel8:7.13
       requireLogin: false
     brokerProperties:
       - addressConfigurations.usDeadLetter.routingTypes=MULTICAST
       - addressConfigurations.usDeadLetter.queueConfigs.usDeadLetter-queue.address=usDeadLetter
       - addressSettings.usa-news.deadLetterAddress=usDeadLetter
       - addressSettings.usa-news.maxDeliveryAttempts=3 # Set to 3 for easier testing
       - addressSettings.'europe-news#'.match='europe-news#'
       - addressSettings.'europe-news#'.deadLetterAddress=usDeadLetter
       - addressSettings.'europe-news#'.maxDeliveryAttempts=2 # Set to 2 for easier testing
   ----

. **Deploy the Broker:**
   Apply the CR to your OpenShift cluster.
   [source,bash]
   ----
   oc apply -f broker-with-deadletter.yaml
   ----
   Wait for the broker pod to be running. You can check its status:
   [source,bash]
   ----
   oc get activemqartemis ex-deadletter-broker -o jsonpath='{.status.brokerStatus[0].state}'
   ----
   It should eventually show `Running`.

. **Access the Broker Management Console:**
   Expose the broker's web console to access it from your local machine.
   [source,bash]
   ----
   oc get route ex-deadletter-broker-amq-broker-console -o jsonpath='{"https://"}{.spec.host}'
   ----
   Open the provided URL in your browser. Log in if required (default username/password if `requireLogin` is false, otherwise check the CR secrets).

. **Send Messages to `usa-news`:**
   You can use a simple message producer (e.g., JMS client, or AMQP client, or even the console's "Send Message" feature if available) to send a few messages to the `usa-news` address. Since there are no consumers for `usa-news`, these messages will remain undelivered.

. **Observe Dead Lettering:**
   After sending a few messages to `usa-news`, refresh the broker management console.
   *   Navigate to the "Addresses" or "Queues" section.
   *   You should eventually see messages appearing in the `usDeadLetter-queue`. The `maxDeliveryAttempts` for `usa-news` is 3. After 3 failed delivery attempts, the broker will move the messages to `usDeadLetter-queue`.

. **Send Messages to a Pattern-Matched Address (e.g., `europe-news.london`):**
   Send a few messages to an address like `europe-news.london` or `europe-news.paris`. These addresses match the `europe-news#` pattern.

. **Verify Dead Lettering for Pattern-Matched Addresses:**
   Again, refresh the console and check the `usDeadLetter-queue`. Messages sent to `europe-news.london` (or similar) should also appear in `usDeadLetter-queue` after 2 failed delivery attempts (as `maxDeliveryAttempts` is 2 for this pattern).

. **Clean Up:**
   Delete the broker instance when you are finished.
   [source,bash]
   ----
   oc delete activemqartemis ex-deadletter-broker
   ----